---
- name: Manage LXD containers using command module
  hosts: localhost
  gather_facts: false
  connection: local
  become: true
  vars:
    molecule_inventory:
      molecule:
        hosts: {}
    molecule_yml:
      platforms:
        - name: instance
          image_fingerprint: "602f1cb373c046923c69c17136eee708c6ea5e8b1d6b7618275ee0ec246b4fe5"
          architecture: x86_64
          user: ansible

  tasks:
    - name: Check if LXD is installed
      ansible.builtin.command: lxd --version
      register: lxd_check
      ignore_errors: true

    - name: Fail if LXD is not installed
      ansible.builtin.fail:
        msg: |
          LXD is not installed on this system.
          Please install LXD before running this playbook.
          For installation instructions, visit: https://linuxcontainers.org/lxd/getting-started-cli/
      when: lxd_check.rc != 0

    - name: Check if LXD is initialized
      ansible.builtin.command: lxd waitready --timeout=5
      register: lxd_initialized
      ignore_errors: true

    - name: Fail if LXD is not initialized
      ansible.builtin.fail:
        msg: "LXD is not initialized or not ready. Please run 'sudo lxd init' manually."
      when: lxd_initialized.rc != 0

    - name: Check if LXD container exists
      ansible.builtin.command: lxc list "{{ platform['name'] }}" --format=json
      register: lxd_container_info
      ignore_errors: true
      loop: "{{ molecule_yml['platforms'] }}"
      loop_control:
        loop_var: platform

    - name: Debug container existence
      ansible.builtin.debug:
        var: lxd_container_info

    - name: Create LXD containers if not exists using lxc launch
      ansible.builtin.command: >
        lxc launch ubuntu-cloud:{{ platform['image_fingerprint'] }} {{ platform['name'] }}
      when: lxd_container_info.results[0].stdout == '[]'
      loop: "{{ molecule_yml['platforms'] }}"
      loop_control:
        loop_var: platform